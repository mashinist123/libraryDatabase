
CREATE PROCEDURE [dbo].[usp_BlackList5]
AS

	MERGE dbo.BlackList AS TARGET
	USING (SELECT DISTINCT PersonID, BookID, DateGive
			FROM [ORDER] 
			WHERE DATEDIFF(YEAR, DateGive, GETDATE()) > = 2 AND DateGet IS NULL) AS SOURCE
	ON TARGET.PersonID = SOURCE.PersonID
	AND TARGET.BookID = SOURCE.BookID
	AND TARGET.DateGet = SOURCE.DateGive

	WHEN NOT MATCHED BY TARGET THEN
	INSERT VALUES (PersonID, BookID, DateGive)
	WHEN NOT MATCHED BY SOURCE THEN DELETE;